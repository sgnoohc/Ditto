#!/bin/bash

ERROR=echo
UL=echo
SUCCESS=echo
MSG=echo
if [ -d "$HOME/login" ]; then
  LOGINEXISTS=true;
  source ~/login/bash/utils.sh
  ERROR=e_error
  UL=e_underline
  SUCCESS=e_success
  MSG=e_msg
fi

usage()
{
  echo "Usage:"
  echo ""
  echo "   $0 ROOTFILE TREECLASSNAME TREEINSTANCENAMEINROOTFILE [FORCE]"
  echo ""
  echo "   e.g. rootfile.root MT2Tree mt2"
  exit
}

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"; $DIR/ditto_setup_check QUIET; if [ $? -eq 1 ]; then exit; fi
if [ -z $1 ]; then usage; fi
if [ -z $2 ]; then usage; fi
if [ -z $3 ]; then usage; fi

ROOTFILE=$1
TREECLASSNAME=$2
TREECLASSNAMESHORT=$3
FORCE=$4

if [ -z ${FORCE} ]; then
  if [ -e ${PACKAGEPATH}/src/${TREECLASSNAME}Looper.h ]; then
    $ERROR "A looper already exists! exiting..."
    exit
  fi

  if [ -e ${PACKAGEPATH}/src/${TREECLASSNAME}Looper.cxx ]; then
    $ERROR "A looper already exists! exiting..."
    exit
  fi
fi

$MSG "generating tree class using make_classfiles.py in ${PACKAGEPATH}/src"
mkdir -p ${PACKAGEPATH}/src/
cd ${PACKAGEPATH}/src/
$DITTOPATH/python/make_classfiles.py -t $TREECLASSNAMESHORT -o mytree -c $TREECLASSNAME $ROOTFILE
mv ${TREECLASSNAME}.cc ${TREECLASSNAME}.cxx

$MSG "copying template tree loopers to the package directory..."

# Copy TREELooper
sed "s/TEMPLATETREENAME/${TREECLASSNAME}/" $DIR/../template/TEMPLATETREELooper.h > ${PACKAGEPATH}/src/${TREECLASSNAME}Looper.h
sed "s/TEMPLATETREENAME/${TREECLASSNAME}/" $DIR/../template/TEMPLATETREELooper.cxx > /tmp/tmp.cxx
sed "s/TEMPLATETREESHORTNAME/${TREECLASSNAMESHORT}/" /tmp/tmp.cxx > ${PACKAGEPATH}/src/${TREECLASSNAME}Looper.cxx

# Copy Binary
sed "s/TEMPLATETREENAME/${TREECLASSNAME}/" $DIR/../template/BINARYNAME.h   > /tmp/tmp.cxx
sed "s/BINARYNAME/${BINARYNAME}/"          /tmp/tmp.cxx                    > ${PACKAGEPATH}/src/${BINARYNAME}.h
sed "s/TEMPLATETREENAME/${TREECLASSNAME}/" $DIR/../template/BINARYNAME.cxx > /tmp/tmp.cxx
sed "s/BINARYNAME/${BINARYNAME}/"          /tmp/tmp.cxx                    > /tmp/tmp2.cxx
sed "s/TEMPLATETREESHORTNAME/${TREECLASSNAMESHORT}/" /tmp/tmp2.cxx         > ${PACKAGEPATH}/src/${BINARYNAME}.cxx

# Copy TREEConnector
sed "s/TREECLASSNAME/${TREECLASSNAME}/" $DIR/../template/TEMPLATETREEConnector.h > ${PACKAGEPATH}/src/${TREECLASSNAME}Connector.h
sed "s/TREECLASSNAME/${TREECLASSNAME}/" $DIR/../template/TEMPLATETREEConnector.cxx > ${PACKAGEPATH}/src/${TREECLASSNAME}Connector.cxx
